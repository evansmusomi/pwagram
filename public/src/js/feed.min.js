const apiUrl={postFetch:"https://pwagramapp.firebaseio.com/posts.json",postSync:"https://us-central1-pwagramapp.cloudfunctions.net/storePostData",getCity:"https://us-central1-pwagramapp.cloudfunctions.net/cityReverseGeocode"};let networkDataReceived=!1;const closeCreatePostModalButton=document.querySelector("#close-create-post-modal-btn"),locationButton=document.querySelector("#location-btn"),locationLoader=document.querySelector("#location-loader"),shareImageButton=document.querySelector("#share-image-button"),createPostArea=document.querySelector("#create-post"),sharedMomentsArea=document.querySelector("#shared-moments"),form=document.querySelector("form"),locationInput=document.querySelector("#location"),titleInput=document.querySelector("#title"),videoPlayer=document.querySelector("#player"),canvasElement=document.querySelector("#canvas"),captureButton=document.querySelector("#capture-btn"),imagePicker=document.querySelector("#image-picker"),imagePickerArea=document.querySelector("#pick-image");let picture,fetchedLocation={lat:0,lng:0};function reverseGeocodeCity(e){fetch(`${apiUrl.getCity}?rawLocationLat=${e.latitude}&rawLocationLng=${e.longitude}`).then(e=>e.json()).then(e=>{locationInput.value=e.city}).catch(console.log)}function initializeLocation(){"geolocation"in navigator||(locationButton.style.display="none")}function initializeMedia(){!1 in navigator&&(navigator.mediaDevices={}),!1 in navigator.mediaDevices&&(navigator.mediaDevices.getUserMedia=(e=>{let t=navigator.webkitGetUserMedia||navigator.mozGetUserMedia;return t?new Promise((o,a)=>{t.call(navigator,e,o,a)}):Promise.reject(new Error("getUserMedia is not implemented!"))})),captureButton.style.display="block",navigator.mediaDevices.getUserMedia({video:!0}).then(e=>{videoPlayer.srcObject=e,videoPlayer.style.display="block"}).catch(e=>{imagePickerArea.style.display="block"})}function shutDownCamera(){videoPlayer.srcObject&&videoPlayer.srcObject.getVideoTracks().forEach(e=>{e.stop()})}function openCreatePostModal(){setTimeout(()=>{createPostArea.style.transform="translateY(0)"},1),initializeMedia(),initializeLocation(),deferredPrompt&&(deferredPrompt.prompt(),deferredPrompt.userChoice.then(e=>{console.log(e.outcome),"dismissed"===e.outcome?console.log("User cancelled installation"):console.log("User added to home screen")}),deferredPrompt=null)}function closeCreatePostModal(){setTimeout(()=>{createPostArea.style.transform="translateY(100vh)"},1),videoPlayer.style.display="none",imagePickerArea.style.display="none",canvasElement.style.display="none",locationButton.style.display="inline",locationLoader.style.display="none",shutDownCamera()}function clearCards(){for(;sharedMomentsArea.hasChildNodes();)sharedMomentsArea.removeChild(sharedMomentsArea.lastChild)}function createCard(e){let t=document.createElement("div");t.className="shared-moment-card mdl-card mdl-shadow--2dp";let o=document.createElement("div");o.className="mdl-card__title",o.style.backgroundImage=`url("${e.image}")`,o.style.backgroundSize="cover",o.style.backgroundPosition="center",t.appendChild(o);let a=document.createElement("h2");a.style.color="white",a.className="mdl-card__title-text",a.textContent=e.title,o.appendChild(a);let n=document.createElement("div");n.className="mdl-card__supporting-text",n.textContent=e.location,n.style.textAlign="center",t.appendChild(n),componentHandler.upgradeElement(t),sharedMomentsArea.appendChild(t)}function updateUI(e){clearCards(),e.forEach(e=>{createCard(e)})}function sendData(){let e=new FormData,t=(new Date).toISOString();e.append("id",t),e.append("title",titleInput.value),e.append("location",locationInput.value),e.append("rawLocationLat",fetchedLocation.lat),e.append("rawLocationLng",fetchedLocation.lng),e.append("file",picture,`${t}.png`),fetch(apiUrl.postSync,{method:"POST",body:e}).then(e=>{console.log("Sent data",e),updateUI(e)})}locationButton.addEventListener("click",e=>{if(!("geolocation"in navigator))return;let t=!1;locationButton.style.display="none",locationLoader.style.display="block",navigator.geolocation.getCurrentPosition(e=>{locationButton.style.display="inline",locationLoader.style.display="none",console.log(e),fetchedLocation={lat:e.coords.latitude,lng:e.coords.longitude},reverseGeocodeCity(e.coords),document.querySelector("#manual-location").classList.add("is-focused")},e=>{console.log(e),locationButton.style.display="inline",locationLoader.style.display="none",t||(alert("Couldn't fetch location, please enter manually!"),t=!0),fetchedLocation={lat:0,lng:0}},{timeout:7e3}),e.preventDefault()}),captureButton.addEventListener("click",e=>{canvasElement.style.display="block",videoPlayer.style.display="none",captureButton.style.display="none",canvasElement.getContext("2d").drawImage(videoPlayer,0,0,canvasElement.width,videoPlayer.videoHeight/(videoPlayer.videoWidth/canvasElement.width)),shutDownCamera(),picture=dataURItoBlob(canvasElement.toDataURL())}),imagePicker.addEventListener("change",e=>{picture=e.target.files[0]}),shareImageButton.addEventListener("click",openCreatePostModal),closeCreatePostModalButton.addEventListener("click",closeCreatePostModal),fetch(apiUrl.postFetch).then(e=>e.json()).then(e=>{networkDataReceived=!0,console.log("From web",e),updateUI(Object.keys(e).map(t=>e[t]))}).catch(console.log),"indexedDB"in window&&readAllData("posts").then(e=>{networkDataReceived||(console.log("From indexeddb",e),updateUI(e))}),form.addEventListener("submit",e=>{e.preventDefault(),""!==titleInput.value.trim()&&""!==locationInput.value.trim()?(closeCreatePostModal(),"serviceWorker"in navigator&&"SyncManager"in window?navigator.serviceWorker.ready.then(e=>{let t={id:(new Date).toISOString(),title:titleInput.value,location:locationInput.value,picture:picture,rawLocation:fetchedLocation};writeData("sync-posts",t).then(()=>e.sync.register("sync-new-posts")).then(()=>{document.querySelector("#confirmation-toast").MaterialSnackbar.showSnackbar({message:"Your post was saved for syncing!"})}).catch(e=>{console.log(e)})}):sendData()):alert("Please enter valid data!")});